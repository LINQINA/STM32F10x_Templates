# GPIO输出与上下拉电阻

## 一、GPIO输出模式

GPIO输出有两种基本类型：

| 类型 | 特点 |
|------|------|
| 推挽输出（Push-Pull） | 可主动输出高电平和低电平 |
| 开漏输出（Open-Drain） | 只能主动输出低电平，高电平需外部上拉 |

---

## 二、推挽输出

### 2.1 内部结构

```
        VCC
         │
        [P-MOS] ← 上管
         │
         ├──────── 输出引脚
         │
        [N-MOS] ← 下管
         │
        GND
```

### 2.2 工作原理

| 输出电平 | 上管(P-MOS) | 下管(N-MOS) | 引脚状态 |
|---------|------------|------------|---------|
| 高电平 | 导通 | 截止 | 连接到VCC |
| 低电平 | 截止 | 导通 | 连接到GND |

### 2.3 特点

- 可主动驱动高低电平
- 驱动能力强
- 一般不需要外部上下拉电阻

---

## 三、开漏输出

### 3.1 内部结构

```
         ×
        [无]  ← 没有上管
         │
         ├──────── 输出引脚
         │
        [N-MOS] ← 只有下管
         │
        GND
```

### 3.2 工作原理

| 输出电平 | 下管(N-MOS) | 引脚状态 |
|---------|------------|---------|
| 低电平 | 导通 | 连接到GND |
| 高电平 | 截止 | 悬空，需外部上拉 |

### 3.3 特点

- 只能主动拉低，无法主动输出高电平
- 必须外接上拉电阻
- 可实现线与逻辑
- 可实现不同电压域电平转换

---

## 四、拉电流与灌电流

### 4.1 定义

| 术语 | 电流方向 | 发生时机 |
|------|---------|---------|
| 拉电流（Source） | 从GPIO流出 | GPIO输出高电平 |
| 灌电流（Sink） | 流入GPIO | GPIO输出低电平 |

### 4.2 图示

```
拉电流（输出高）：              灌电流（输出低）：

      GPIO                          VCC
        │                            │
        ↓ 电流流出                  [负载]
        │                            │
      [负载]                         ↓ 电流流入
        │                            │
       GND                         GPIO
```

### 4.3 典型LED驱动电路

```
灌电流驱动（常用）：            拉电流驱动：

     VCC                         GPIO输出高
      │                            │
     [R]                           ↓
      │                          [LED]
    [LED]                          │
      │                           [R]
      ↓                            │
    GPIO输出低                    GND
```

---

## 五、驱动能力

### 5.1 GPIO驱动能力

GPIO驱动能力指芯片能提供或吸收的最大电流，是固定值。

| 参数 | 含义 | 典型值(STM32) |
|------|------|--------------|
| IOH | 最大拉电流 | 25mA |
| IOL | 最大灌电流 | 25mA |
| VOH | 输出高电平最低电压 | VCC-0.4V |
| VOL | 输出低电平最高电压 | 0.4V |

### 5.2 不同模式下的驱动来源

| 输出模式 | 输出高电平 | 输出低电平 |
|---------|-----------|-----------|
| 推挽输出 | GPIO驱动（P-MOS） | GPIO驱动（N-MOS） |
| 开漏输出 | **上拉电阻驱动** | GPIO驱动（N-MOS） |

### 5.3 开漏输出时上拉电阻的影响

| 上拉电阻 | 高电平驱动能力 | 上升沿速度 | 输出低时GPIO灌电流 |
|---------|--------------|-----------|------------------|
| 小（1kΩ） | 强 | 快 | 大（3.3mA） |
| 中（10kΩ） | 中等 | 中等 | 中等（0.33mA） |
| 大（100kΩ） | 弱 | 慢 | 小（0.033mA） |

开漏输出高电平的驱动能力由上拉电阻决定，不是GPIO本身。

### 5.4 驱动能力不足的影响

- 输出电平达不到预期
- GPIO过热
- 可能损坏芯片

### 5.5 GPIO直接驱动能力参考

| 负载类型 | 典型电流 | GPIO能否直接驱动 |
|----------|---------|-----------------|
| LED | 3~20mA | 可以 |
| 数字芯片输入 | μA级 | 可以 |
| 继电器线圈 | 50~100mA | 不行，需扩流 |
| 电机 | 几百mA~几A | 不行，需扩流 |

大电流负载需使用MOS管或三极管扩流。

---

## 六、上下拉电阻对GPIO输出的影响

### 6.1 推挽输出

推挽输出正常情况下不需要外部上下拉电阻。

加上下拉电阻时的影响：

| 情况 | 电压差 | 电流 | 影响 |
|------|--------|------|------|
| 上拉 + 输出高 | ≈0 | ≈0 | 无影响 |
| 上拉 + 输出低 | VCC | VCC/R | 消耗灌电流能力 |
| 下拉 + 输出高 | VCC | VCC/R | 消耗拉电流能力 |
| 下拉 + 输出低 | ≈0 | ≈0 | 无影响 |

规律：输出方向与上下拉方向相同时无影响，相反时消耗驱动能力。

### 6.2 开漏输出

开漏输出必须外接上拉电阻。

上拉电阻选择需权衡：
- 电阻小：高电平驱动强、响应快，但输出低时功耗大
- 电阻大：功耗低，但高电平驱动弱、响应慢

### 6.3 推挽输出加上下拉的特殊场景

| 场景 | 目的 |
|------|------|
| 上电保护 | MCU复位期间GPIO高阻态，上下拉确保默认安全状态 |
| 防止误动作 | 确保负载在MCU启动前不误动作 |

---

## 七、常见GPIO输出电路

### 7.1 LED驱动（灌电流方式）

```
        VCC
         │
        [R] 限流电阻
         │
       [LED]
         │
        GPIO (推挽输出)
```

### 7.2 MOS管驱动（带下拉保护）

```
       VCC_负载
         │
       [负载]
         │
        [D] 续流二极管
         │
         D
       [N-MOS]
        G──┬── GPIO
        S  │
        │ [R] 下拉电阻（10kΩ）
       GND │
          GND
```

下拉电阻确保上电瞬间MOS截止，防止误动作。

### 7.3 I2C总线（开漏+上拉）

```
        VCC
         │
       [4.7kΩ] 上拉电阻
         │
         ├─────── 到其他设备
         │
        GPIO (开漏输出)
```

### 7.4 电平转换（开漏+上拉）

```
       VCC_3.3V
         │
       [4.7kΩ]
         │
         ├─────── 到3.3V器件
         │
        GPIO (5V系统，开漏输出)
```

---

## 八、软件工程师要点

1. **了解输出模式区别**
   - 推挽输出：高低电平都由GPIO驱动，一般不需外部上下拉
   - 开漏输出：低电平由GPIO驱动，高电平由上拉电阻驱动

2. **注意驱动能力限制**
   - GPIO驱动能力固定（通常20~25mA）
   - 大电流负载需要MOS管或三极管扩流

3. **查看原理图确认电路**
   - 有下拉保护电阻时，注意初始化时序
   - 开漏输出确认有上拉电阻

4. **上下拉电阻对输出的影响**
   - 输出方向与上下拉同向时无影响
   - 输出方向与上下拉反向时消耗驱动能力（电阻大则影响小）
