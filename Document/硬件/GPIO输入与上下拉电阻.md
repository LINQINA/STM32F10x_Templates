# GPIO输入与上下拉电阻

## 一、上下拉电阻的作用

GPIO配置为输入模式时，若引脚悬空，电平处于不确定状态，易受干扰导致程序行为异常。

上下拉电阻用于给悬空引脚提供确定的默认电平。

| 类型 | 连接方式 | 默认电平 |
|------|---------|---------|
| 上拉电阻 | GPIO ↔ VCC | 高电平 |
| 下拉电阻 | GPIO ↔ GND | 低电平 |

---

## 二、内部上下拉与外部上下拉

### 2.1 特性对比

| 特性 | 内部上下拉 | 外部上下拉 |
|------|-----------|-----------|
| 阻值 | 固定（30k~50kΩ） | 可自由选择 |
| 精度 | ±50%，偏差大 | ±1%~5%，精确可控 |
| 使用方式 | 软件配置 | 硬件电路实现 |

### 2.2 外部上下拉的适用场景

| 场景 | 原因 |
|------|------|
| 长线缆/强干扰环境 | 需要更小电阻（1k~4.7kΩ）增强抗干扰能力 |
| 超低功耗应用 | 需要更大电阻（100kΩ+）降低静态功耗 |
| I2C等总线协议 | 协议规范要求特定阻值（如4.7kΩ） |
| 精确阻值需求 | 内部上下拉精度无法满足要求 |

### 2.3 选型建议

- 普通按键、简单开关：内部上下拉即可满足
- 特殊需求场景：使用外部上下拉

---

## 三、电阻值选取参考

| 应用场景 | 推荐阻值 | 说明 |
|----------|---------|------|
| 普通按键 | 10kΩ | 平衡功耗与抗干扰能力 |
| I2C总线 | 4.7kΩ | 协议规范要求 |
| 高速信号/长线缆 | 1kΩ ~ 2.2kΩ | 低阻抗，抗干扰强，响应快 |
| 低功耗/电池供电 | 47kΩ ~ 100kΩ | 降低静态电流 |
| 一般数字输入 | 4.7kΩ ~ 10kΩ | 通用选择 |

### 电阻大小的权衡

| 大电阻 | 小电阻 |
|--------|--------|
| 功耗低 | 功耗高 |
| 抗干扰能力弱 | 抗干扰能力强 |
| 响应速度慢 | 响应速度快 |

---

## 四、内外配置原则

### 4.1 正确配置（同向或单独使用）

| 外部配置 | 内部配置 | 结果 |
|---------|---------|------|
| 上拉 | 上拉 | 并联，阻值变小，正常工作 |
| 上拉 | 浮空 | 仅外部生效，正常工作 |
| 下拉 | 下拉 | 并联，阻值变小，正常工作 |
| 下拉 | 浮空 | 仅外部生效，正常工作 |
| 无 | 上拉/下拉 | 仅内部生效，正常工作 |

### 4.2 错误配置（反向配置导致分压）

| 外部配置 | 内部配置 | 结果 |
|---------|---------|------|
| 上拉 | 下拉 | 分压，电平不确定 |
| 下拉 | 上拉 | 分压，电平不确定 |

反向配置时的电路分析：

```
     VCC (3.3V)
      │
     [外部上拉 10kΩ]
      │
      ├──── GPIO
      │
     [内部下拉 40kΩ]
      │
     GND
```

根据分压公式计算：

```
V_GPIO = VCC × R下 / (R上 + R下)
       = 3.3V × 40kΩ / (10kΩ + 40kΩ)
       = 2.64V
```

该电压接近高电平阈值边界，易受干扰导致电平跳变。

---

## 五、分压公式

```
        VCC
         │
        [R上]
         │
         ├──── V节点 = VCC × R下 / (R上 + R下)
         │
        [R下]
         │
        GND
```

节点对GND的电压等于总电压乘以下方电阻占总电阻的比例。

---

## 六、GPIO输入特性

- 输入阻抗：约100MΩ（极高）
- 输入电流：nA级别（可忽略）
- 工作原理：GPIO输入仅检测电压，几乎不消耗电流，电流经其他低阻抗路径流过

---

## 七、软件工程师要点

1. **输入引脚禁止悬空**
   - 必须配置上拉或下拉（内部或外部）

2. **内外配置方向保持一致**
   - 查看原理图确认外部电阻配置
   - 外部上拉时，软件配置为上拉或浮空
   - 外部下拉时，软件配置为下拉或浮空
   - 反向配置将导致电平不确定

3. **上下拉决定默认电平**
   - 上拉：默认高电平，检测低电平触发
   - 下拉：默认低电平，检测高电平触发
   - 代码逻辑需与硬件配置对应

4. 为什么需要上下拉电阻

   ​    为了以防万一，如果3.3V直连芯片，如果配置的是输入，阻抗很高，不会坏，但是如果配置错了，配置成了输出0V，则直接短路烧IO了，以下是可能的万一情况

   ```
   1.上电/复位瞬间
   2.程序BUG
   3.复用功能切换
   4.人为操作错误
   ```

---

## 八、典型按键电路

### 电路结构

```
     VCC
      │
     [上拉电阻 10kΩ]
      │
      ├──── GPIO输入
      │
     [按键]
      │
     GND
```

- 按键松开：GPIO为高电平
- 按键按下：GPIO为低电平

### 代码示例

```c
// GPIO配置
GPIO_InitStruct.Mode = GPIO_MODE_INPUT;
GPIO_InitStruct.Pull = GPIO_NOPULL;  // 外部已有上拉，内部配置为浮空
HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

// 按键检测
if (HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_0) == GPIO_PIN_RESET) {
    // 检测到低电平，按键按下
}
```
